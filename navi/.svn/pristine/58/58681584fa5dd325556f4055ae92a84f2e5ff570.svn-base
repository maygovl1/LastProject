<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.navi.mypage.dao.MypageDAO">
	<resultMap type="ProjectVO" id="projectMap"
		autoMapping="true">
		<id property="proId" column="PRO_ID" />
		<collection property="teamList" ofType="TeamVO"
			autoMapping="true">
			<id property="proId" column="PRO_ID" />
			<id property="empId" column="EMP_ID" />
		</collection>
	</resultMap>

	<sql id="searchFrag">
		<trim suffixOverrides="AND">
			<if test="not paging.detailCondition.empty">
				AND
				<if
					test="@org.apache.commons.lang3.StringUtils@isNotBlank(paging.detailCondition.projectState)">
					PRO_ST_ID = #{paging.detailCondition.projectState} AND
				</if>
				<if
					test="paging.detailCondition.state != null and paging.detailCondition.state == 'end'">
					PRO_DDLINE_YN IS NOT NULL AND
				</if>
				<if
					test="paging.detailCondition.state != null and paging.detailCondition.state == 'ing'">
					PRO_DDLINE_YN IS NULL AND
				</if>
				<if
					test="@org.apache.commons.lang3.StringUtils@isNotBlank(paging.detailCondition.project)">
					INSTR(P.PRO_ID, #{paging.detailCondition.project}) > 0
					OR
					INSTR(P.PRO_NAME, #{paging.detailCondition.project}) > 0
				</if>
			</if>
		</trim>
	</sql>

	<select id="myProjectList" resultMap="projectMap"
		parameterType="PaginationInfo">
		SELECT B.*
		FROM (
		SELECT ROWNUM RNUM, A.*
		FROM (
		SELECT
		P.PRO_ID,
		P.PRO_NAME,
		P.PRO_DESC,
		P.PRO_REG_DT,
		P.PRO_DDLINE_EX,
		P.PRO_DDLINE_DT,
		P.PRO_DDLINE_YN,
		P.PRO_DEL_YN,
		E.EMP_NAME,
		C.CM_NAME
		FROM
		PROJECT P
		INNER
		JOIN
		TEAM T ON P.PRO_ID = T.PRO_ID
		INNER JOIN
		EMP E ON
		T.EMP_ID = E.EMP_ID
		INNER JOIN
		COMMON C ON P.PRO_ST_ID = C.CM_ID
		WHERE
		T.ROLE_ID = 'ROLE_PL'
		AND
		P.PRO_ID IN (SELECT PRO_ID FROM TEAM WHERE
		EMP_ID = #{empId})
		<include refid="searchFrag" />
		ORDER BY P.PRO_REG_DT DESC
		) A
		) B
		<where>
			<if test="paging.startRow gt 0 and paging.endRow gt 0">
                <![CDATA[
                RNUM >= #{paging.startRow} AND RNUM <= #{paging.endRow}
                ]]>
			</if>
		</where>
	</select>

	<select id="selectTotalRecord">
		WITH PROJ AS (
		SELECT
		P.PRO_ID,
		P.PRO_NAME,
		P.PRO_DESC,
		P.PRO_REG_DT,
		P.PRO_DDLINE_EX,
		P.PRO_DDLINE_DT,
		P.PRO_DDLINE_YN,
		P.PRO_DEL_YN,
		E.EMP_NAME,
		C.CM_NAME
		FROM
		PROJECT P
		INNER JOIN
		TEAM T ON P.PRO_ID =
		T.PRO_ID
		INNER JOIN
		EMP E ON T.EMP_ID = E.EMP_ID
		INNER JOIN
		COMMON C ON
		P.PRO_ST_ID = C.CM_ID
		WHERE
		T.ROLE_ID = 'ROLE_PL' AND
		P.PRO_ID IN (SELECT
		PRO_ID FROM TEAM WHERE EMP_ID = #{empId})
		<include refid="searchFrag" />
		)
		SELECT COUNT(*) FROM PROJ
	</select>

	<update id="updateEmp" parameterType="EmpVO">
		UPDATE EMP
		SET
		EMP.EMP_PASS = #{empPass,jdbcType=VARCHAR}
		, EMP.EMP_RRNO
		= #{empRrno,jdbcType=VARCHAR}
		, EMP.EMP_PHONE =
		#{empPhone,jdbcType=VARCHAR}
		, EMP.EMP_ZIP = #{empZip,jdbcType=CHAR}
		,
		EMP.EMP_ADDR = #{empAddr,jdbcType=VARCHAR}
		, EMP.EMP_ADDR2 =
		#{empAddr2,jdbcType=VARCHAR}
		, EMP.EMP_MAIL =
		#{empMail,jdbcType=VARCHAR}
		, EMP.EMP_CMP_YMD =
		#{empCmpYmd,jdbcType=TIMESTAMP}
		, EMP.EMP_CAREER =
		#{empCareer,jdbcType=NUMERIC}
		<if test="empImg neq null and empImg.length gt 0">
			, EMP.EMP_IMG = #{empImg,jdbcType=VARCHAR}
		</if>
		WHERE EMP_ID = #{empId}
	</update>
</mapper>