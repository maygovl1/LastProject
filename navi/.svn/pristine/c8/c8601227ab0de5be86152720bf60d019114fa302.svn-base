/**
 * 현재 페이지의 기본 URI를 가져옵니다.
 */
	
function getCsrfToken(){
   return document.querySelector('meta[name="_csrf"]').getAttribute('content');
}

// CSRF 헤더를 가져오는 함수
function getCsrfHeader(){
   return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
}
  
$("#chatForm").on("submit", function(event) {
	console.log(event)
   let url = this.action; // form의 action 속성을 가져옴
   let method = this.method; // form의 method 속성을 가져옴
   let listBody = document.querySelector("#listBody"); // listBody 요소를 가져옴
   event.preventDefault(); // 기본 동작 방지

   // fetch를 통해 데이터를 서버에 전송
   fetch(url, {
      method: "POST",
      headers: {
         "Accept": "application/json",
         [getCsrfHeader()]: getCsrfToken() // CSRF 헤더 추가
      }
   }).then(resp => {
      if (resp.ok) {
         return resp.json(); // JSON 형식의 응답을 반환
      } else {
         throw new Error("오류발생", { cause: resp }) // 오류 발생 시 에러 처리
      }
   }).then(jsonObj => {
      console.log(jsonObj) // JSON 데이터 출력
      for (let e of jsonObj) {
         // mberList에 데이터 추가
         empList.add({
			'empImg': e.empImg + 2 ,
            'empOne': e.empName + e.psName + '(' + e.deptName + ')',
         });	
      }
   }).catch(err => {
      console.error(err) // 오류 출력
   }).finally(() => {
      // 빈 td 요소 숨기기
      var tdList = document.querySelectorAll('#empList span');
      tdList.forEach(function(span) {
         if (span.innerHTML.trim() === '') {
            span.style.display = 'none';
         }
      });
	var imgList = document.querySelectorAll('#empList img');
	imgList.forEach(function(img) {
	    if (img.src.trim() === '') {
	        img.style.display = 'none';
	    }
	});
   })
   return false; // 기본 동작 방지
})

//채팅방 불러오기
$(document).on("click", ".empOne", function() {
    var empId = $(this).data('emp-id');
	console.log("empId", empId)
	
    // 서버로 empId를 전송하여 채팅방 정보를 요청
    $.ajax({
        url: '/check-chat-room',
        type: 'POST',
        data: { empId: empId },
        success: function(data) {
            if (data.roomId) {
                // 기존 채팅방이 있는 경우
                var roomId = data.roomId;
                openChatRoom(roomId);
            } else {
                // 새로운 채팅방이 필요한 경우
                createNewChatRoom(empId);
            }
        },
        error: function(xhr, status, error) {
            console.error('채팅방 확인 실패:', error);
        }
    });
});

function openChatRoom(roomId) {
    var popupUrl = 'chat/chatRoom?roomId=' + roomId;
    window.open(popupUrl, 'Chat Room', 'width=600,height=400');
}

function createNewChatRoom(empId) {
    // 새로운 채팅방을 생성하고 roomId를 받아옴
    // 여기에 새로운 채팅방 생성 및 roomId를 처리하는 코드를 추가해야 함
}

function loadScript(){
	let options = { "valueNames": ["empId", "empImg", "empOne"], "page": Infinity, "pagination": false } 
	empList = new List('cstmrList', options)
	console.log($(chatForm))
	$("#chatForm").submit(); // chatForm 제출
	
    const empImg = document.querySelector('.empImg');
    empImg.addEventListener('click', function() {
        const dropdownMenu = this.nextElementSibling;
        dropdownMenu.classList.toggle('show');
    });

    window.addEventListener('click', function(e) {
        if (!empImg.contains(e.target)) {
            const dropdownMenus = document.querySelectorAll('.dropdown-menu');
            dropdownMenus.forEach(function(menu) {
                if (menu.classList.contains('show')) {
                    menu.classList.remove('show');
                }
            });
        }
    });
}

loadScript();
