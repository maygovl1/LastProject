<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<div class="modal fade" id="taskModal" tabindex="-1"
	aria-labelledby="exampleModalLabel" aria-hidden="true"
	data-pro-id="${project.proId }">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<strong class="modal-title fs-5" id="exampleModalLabel">안내</strong>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body" id="in">
				<div id="taskList" data-list>
					<div class="row justify-content-end g-0">
						<div class="col-auto col-sm-5 mb-3">
							<form id="submitForm1"
								action="${pageContext.request.contextPath }/task/child/${task.taskId }"
								method="post">
								<div class="input-group">
									<input class="form-control form-control-sm shadow-none search"
										type="search" placeholder="Search..." aria-label="search" />
									<div class="input-group-text bg-transparent">
										<span class="fa fa-search fs-10 text-600"></span>
									</div>
								</div>
							</form>
						</div>
					</div>
					<div class="table-responsive scrollbar">

						<table class="table table-bordered table-striped fs-10 mb-0">
							<thead class="bg-200">
								<tr>
									<th class="text-900 sort" data-sort="taskId">일감번호</th>
									<th class="text-900 sort" data-sort="taskName">제목</th>
									<th class="text-900 sort" data-sort="taskManName">담당자</th>
									<th class="text-900 sort" data-sort="btn">선택</th>
								</tr>
							</thead>
							<tbody class="list" id="listBody1">
								<tr>
									<td class="taskId"></td>
									<td class="taskName"></td>
									<td class="taskManName"></td>
									<td class="btn"></td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="d-flex justify-content-center mt-3">
						<button class="btn btn-sm btn-falcon-default me-1" type="button"
							title="Previous" data-list-pagination="prev">
							<span class="fas fa-chevron-left"></span>
						</button>
						<ul class="pagination mb-0"></ul>
						<button class="btn btn-sm btn-falcon-default ms-1" type="button"
							title="Next" data-list-pagination="next">
							<span class="fas fa-chevron-right"> </span>
						</button>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="submit" class="btn btn-secondary"
					data-bs-dismiss="modal">확인</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="deleteModal" tabindex="-1"
	aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<strong class="modal-title fs-5" id="deleteModalLabel">안내</strong>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body" id="deleteResult">"일감을 삭제하시겠습니까?"</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">닫기</button>
				<button type="button" class="btn btn-danger" id="deleteBtn">삭제</button>
			</div>
		</div>
	</div>

</div>

<div class="btn-box clearfix mt-4">
	<div class="right float-end">
		<button class="btn btn-primary" data-bs-toggle="modal"
			data-bs-target="#taskModal">하위 일감 조회</button>
	</div>
</div>
<!-- project veiw -->
<div class="view task">
	<div class="view_inner">
		<div class="view-info">
			<strong class="view-tit"> <span class="category project">T00001</span>
				<em>${task.taskTitle }</em></strong>
			<ul class="ul clearfix">

				<li><span class="list-tit">담당자</span> <span>${task.taskManEmp.empName }(${task.taskManEmp.deptName },${task.taskManEmp.psName })</span>
					<!-- <select class="select-box" aria-label="Default select example">
                                    <option selected>우민규(디자인1팀, 사원)</option>
                                    <option value="1">유길상(디자인1팀, 사원)</option>
                                    <option value="2">정민지(디자인1팀, 사원)</option>
                                    <option value="4">이상철(디자인1팀, 사원)</option>
                                    <option value="5">김태은(디자인1팀, 사원)</option>
                                </select> --></li>
				<!-- <li><span class="list-tit">진행기간</span><span>2024.04.05</span></li> -->
				<li><span class="list-tit">진행율</span>
					<div class="progress">
						<div class="progress-bar" role="progressbar"
							aria-label="Example with label"
							style="width: ${task.taskProcessStatus.tpsIng };"
							aria-valuenow="30" aria-valuemin="0" aria-valuemax="100">${task.taskProcessStatus.tpsIng }</div>
					</div> <!-- <select class="select-box" aria-label="Default select example">
                                    <option selected>10%</option>
                                    <option value="1">30%</option>
                                    <option value="2">50%</option>
                                    <option value="3">70%</option>
                                    <option value="4">90%</option>
                                    <option value="5">99%</option>
                                </select> --></li>
				<li><span class="list-tit">처리기한</span> <span>${task.taskCompDtStr }</span>

				</li>
				<li><span class="list-tit">수정일</span> <c:if
						test="${not empty task.taskModDt }">
						<span>${task.taskModDtStr }</span>
					</c:if> <c:if test="${empty task.taskModDt }">
						<span>수정내역 없음</span>
					</c:if></li>
				<li><span class="list-tit">등록일</span><span>${task.taskRegDtStr }</span></li>
				<!-- 프로젝트 상태값:
                                        <li><span class="">상태</span><span>신규</span></li>
                                        <li><span class="">상태</span><span>안정</span></li>
                                        <li><span class="">상태</span><span>긴급</span></li>
                                -->
				<li><span class="list-tit">등록자</span><span>${task.regEmp.empName }</span></li>
			</ul>
		</div>
		<div class="view_content">${task.taskCn }</div>

	</div>

</div>
<!-- project veiw -->
<!-- button -->
<div class="btn-box clearfix mt-4">
	<a href="${pageContext.request.contextPath }/task"><button
			class="btn btn-secondary">목록</button></a>
	<div class="right float-end">
		<!-- <button class="btn btn-danger">취소</button> -->
		<button class="btn btn-danger" data-bs-toggle="modal"
			data-bs-target="#deleteModal">삭제</button>
		<a
			href="${pageContext.request.contextPath }/project/task/${project.proId }/mod/${task.taskId}">
			<button class="btn btn-primary">수정</button>
		</a>
	</div>
</div>
<!-- button -->
<script>
$(document).ready(function(){
	const cPath = document.body.dataset.contextPath;
	   function getCsrfToken(){
	      return document.querySelector('meta[name="_csrf"]').getAttribute('content');
	   }
	   function getCsrfHeader(){
	      return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	   }
	   
	$(deleteBtn).on("click", function(e){
		
		fetch(cPath+"/task/${task.taskId}",{
			method:"DELETE",
			headers:{
				"accept":"application/json",
				[getCsrfHeader()]: getCsrfToken()
			}
		}).then(resp=>{
			if(resp.ok){
				return resp.json()
			}else{
				throw new Error("상태코드 "+resp.status)
			}
		}).then(jsonObj=>{
			console.log(jsonObj)
			if(jsonObj.msg=='ok'){
				deleteResult.innerHTML="삭제가 완료되었습니다."
				window.location.pathname='${pageContext.request.contextPath}/project/task/${project.proId}'
			}else{
				deleteResult.innerHTML="삭제에 실패했습니다."
			}
		})
	})
	
	
})
</script>

<script src="${pageContext.request.contextPath }/resources/js/listjs/taskDet.js"></script>

