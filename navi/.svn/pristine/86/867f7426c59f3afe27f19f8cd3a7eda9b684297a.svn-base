package kr.or.navi.chat.server;

import java.io.IOException;
import java.io.StringReader;
import java.util.Collections;
import java.util.HashSet;
import java.util.Random;
import java.util.Set;

import javax.json.Json;
import javax.json.JsonArrayBuilder;
import javax.json.JsonObject;
import javax.websocket.EncodeException;
import javax.websocket.OnClose;
import javax.websocket.OnError;
import javax.websocket.OnMessage;
import javax.websocket.OnOpen;
import javax.websocket.Session;
import javax.websocket.server.ServerEndpoint;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import kr.or.navi.chat.server.config.ServerAppConfig;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@ServerEndpoint(value = "/usersServerEndpoint", configurator = ServerAppConfig.class)
public class UsersServerEndPoint {
	private static final Logger LOGGER = LoggerFactory.getLogger(UsersServerEndPoint.class);
	private static Set<Session> connectedAllUsers = Collections.synchronizedSet(new HashSet<Session>());

	/**
	 * Handshaking í•¨ìˆ˜
	 * @param userSession ì‚¬ìš©ì session
	 */
	@OnOpen
	public void handleOpen(Session userSession) {
		log.info("ğŸŠğŸŠğŸŠğŸŠOpen ConnectionğŸŠğŸŠğŸŠğŸŠ");
		connectedAllUsers.add(userSession);
	}
	
	/**
	 * ì—°ê²°ì„ ëŠê¸° ì§ì „ì— í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
	 * @param userSession
	 * @throws IOException
	 * @throws EncodeException
	 */
	@OnClose
	public void handleClose(Session userSession) throws IOException, EncodeException {
		
		log.info("ğŸŠğŸŠğŸŠğŸŠCloses ConnectionğŸŠğŸŠğŸŠğŸŠ");
		String disconnectedUser = (String) userSession.getUserProperties().get("username");
		connectedAllUsers.remove(userSession);

		if (disconnectedUser != null) {
			Json.createObjectBuilder().add("disconnectedUser", disconnectedUser).build().toString();

			for (Session session : connectedAllUsers) {
				session.getBasicRemote().sendText(
						Json.createObjectBuilder().add("disconnectedUser", disconnectedUser).build().toString());
			}
		}
	}
	
	@OnError
	public void onError(Throwable e) {
		e.printStackTrace();
	}

	/**
	 * Messageì „ë‹¬ í•¨ìˆ˜
	 *
	 * @param message     ë©”ì‹œì§€
	 * @param userSession ì‚¬ìš©ì session
	 * @throws IOException
	 * @throws EncodeException
	 */
	
	@OnMessage
	public void handleMessage(String message, Session userSession) throws IOException, EncodeException {
		String username = (String) userSession.getUserProperties().get("username");

		JsonObject jsonObject = Json.createReader(new StringReader(message)).readObject();

		String connectionType = jsonObject.getString("connectionType");

		if ("firstConnection".equals(connectionType) && username == null) {
			// ë§¨ ì²˜ìŒ ì ‘ì† ì‹œ,
			// ì‚¬ìš©ìì˜ ì´ë¦„ì„ ê°€ì ¸ì˜´
			username = jsonObject.getString("username");

			LOGGER.info(username + " is entered.");

			if (username != null && !isExisted(username)) {
				userSession.getUserProperties().put("username", username);

				for (Session session : connectedAllUsers) {
					session.getBasicRemote().sendText(buildJsonUserData(getUsers()));
				}
			} else {
				// usernameì„ ë‹¤ì‹œ ì…ë ¥í•˜ê²Œí•˜ëŠ” ë¡œì§ ë„£ê¸°.
			}

		} else if ("chatConnection".equals(connectionType)) {
			// chatroomIdë¡œ ë˜ë‹¤ë¥¸ webSocket urlì— ì ‘ê·¼í•œë‹¤.
			// id generationìœ¼ë¡œ ëŒ€ì²´ê°€ëŠ¥.
			String chatroomId = genRandom();

			// ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ëŒ€í™”í•˜ê³ ì ì‹œë„í•  ë•Œ
			// ì±„íŒ…ë£¸ ì‚¬ìš©ì ì €ì¥
			Set<Session> chatroomMembers = new HashSet<Session>();
			chatroomMembers.add(userSession);

			// ì„ íƒí•œ ì‚¬ìš©ìë¥¼ ì‚¬ìš©ìë“¤ ì•ˆì—ì„œ ì°¾ê¸°.
			String connectingUser = jsonObject.getString("connectingUser");

			if (connectingUser != null && !username.equals(connectingUser)) {
				// ì‚¬ìš©ìë“¤ ì¤‘ ì„ íƒí•œ ìœ ì €ì™€ ì—°ê²°
				for (Session session : connectedAllUsers) {
					if (connectingUser.equals(session.getUserProperties().get("username"))) {
						// ì„ íƒí•œ ì‚¬ìš©ìë©´ chatroomMemberë¡œ ì¶”ê°€.
						chatroomMembers.add(session);
					}
				}

				// chatroomMembersì—ê²Œ roomì…ì¥í•˜ë¼ëŠ” ì‹ í˜¸ ë³´ë‚´ê¸°
				for (Session session : chatroomMembers) {

					session.getBasicRemote().sendText(Json.createObjectBuilder().add("enterChatId", chatroomId)
							.add("username", (String) session.getUserProperties().get("username")).build().toString());
				}
			}
		}
	}


	/**
	 * ì—°ê²°ë˜ì–´ìˆëŠ” userì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
	 *
	 * @return user set
	 */
	private Set<String> getUsers() {
		HashSet<String> returnSet = new HashSet<String>();

		for (Session session : connectedAllUsers) {
			if (session.getUserProperties().get("username") != null) {
				returnSet.add(session.getUserProperties().get("username").toString());
			}
			;
		}
		return returnSet;
	}

	/**
	 * ìœ ì € ì •ë³´ê°€ ë‹´ê¸´ Set<String>ì„ jsonìœ¼ë¡œ ë³€í™˜í•´ì£¼ëŠ” í•¨ìˆ˜
	 *
	 * @param set
	 * @return jsondata
	 */
	private String buildJsonUserData(Set<String> set) {

		JsonArrayBuilder jsonArrayBuilder = Json.createArrayBuilder();

		for (String user : set) {
			jsonArrayBuilder.add(user);
		}
		return Json.createObjectBuilder().add("allUsers", jsonArrayBuilder).build().toString();
	}

	/**
	 * ë™ì¼í•œ usernameì„ ê°€ì§„ user sessionì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
	 *
	 * @param username ì‚¬ìš©ìì´ë¦„
	 * @return ì¡´ì¬ì—¬ë¶€
	 */
	private boolean isExisted(String username) {
		// ì´ë¯¸ usernameì„ ê°€ì§„ sessionì´ ìˆëŠ”ì§€ ê²€ì‚¬.
		for (Session existedUser : connectedAllUsers) {
			if (username.equals(existedUser.getUserProperties().get("username"))) {
				return true;
			}
		}
		return false;
	}

	/**
	 * chatroomIdë¥¼ ìœ„í•œ ëœë¤ê°’ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
	 *
	 * @return chatroomId
	 */
	private String genRandom() {
		String chatroomId = "";
		for (int i = 0; i < 8; i++) {
			chatroomId += (char) ((new Random().nextDouble() * 26) + 97);// KISA ë³´ì•ˆì•½ì  ì¡°ì¹˜ (2018-10-29, ìœ¤ì°½ì›)
		}
		return chatroomId;
	}

}
