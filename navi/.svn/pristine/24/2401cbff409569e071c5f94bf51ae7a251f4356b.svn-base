
function getCsrfToken() {
    return document.querySelector('meta[name="_csrf"]').getAttribute('content');
}

function getCsrfHeader() {
    return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
}

function sendGetRequest(url) {
    const headers = {
        "Accept": "text/html",
        [getCsrfHeader()]: getCsrfToken()
    };

    return fetch(url, {
        method: "GET",
        headers: headers
    });
}

function sendPostRequest(url, data) {
    const headers = {
        "Accept": "application/json",
        "Content-Type": "application/json",
        [getCsrfHeader()]: getCsrfToken()
    };

    return fetch(url, {
        method: "POST",
        headers: headers,
        body: JSON.stringify(data)
    });
}


function removeScript(){
    let scripts = $('script');
   
    let scriptList = [
        `${cPath}/resources/mypage/js/chatEmpList.js`,
        `${cPath}/resources/mypage/js/chatMove.js`,
    ]
   
    for(script of scripts){
        for(url of scriptList){
            if(script.src.includes(url)){
                script.remove();            
            }
        }
    }
}

$(".empList").on('click', function() {
    // button class "empList"
    const empListurl = cPath + "/chat/chatEmpList";
    sendGetRequest(empListurl)
    .then(resp => {
        if (resp.ok) {
            return resp.text(); // HTML 형식의 응답을 반환
        } else {
            throw new Error("오류발생", { cause: resp }); // 오류 발생 시 에러 처리
        }
    })
    .then(html => {
        // 성공적으로 데이터를 받아온 경우, 친구 리스트로 교체
        $('.chat_in').html(html);

        // 기존에 추가된 스크립트 제거
        removeScript();

        // 새로운 스크립트 추가
        $("<script/>", {
            src: `${cPath}/resources/mypage/js/chatEmpList.js`,
            type: "text/javascript"
        }).appendTo("body");

        $("<script/>", {
            src: `${cPath}/resources/mypage/js/chatMove.js`,
            type: "text/javascript"
        }).appendTo("body");
    })
    .catch(err => {
        console.error(err);
    });
});

$(".chatList").on('click', function(){
	const chatListurl = cPath + "/chat/chatList"
	sendGetRequest(chatListurl)
    .then(resp => {
        if (resp.ok) {
            return resp.text(); // HTML 형식의 응답을 반환
        } else {
            throw new Error("오류발생", { cause: resp }); // 오류 발생 시 에러 처리
        }
    })
    .then(html => {
        // 성공적으로 데이터를 받아온 경우, 친구 리스트로 교체
        $('.chat_in').html(html);

        // 기존에 추가된 스크립트 제거
        removeScript();

        // 새로운 스크립트 추가
        $("<script/>", {
            src: `${cPath}/resources/mypage/js/chatList.js`,
            type: "text/javascript"
        }).appendTo("body");

        $("<script/>", {
            src: `${cPath}/resources/mypage/js/chatMove.js`,
            type: "text/javascript"
        }).appendTo("body");
    })
    .catch(err => {
        console.error(err);
    });
});
