package kr.or.navi.chat.server;

import java.io.IOException;
import java.io.StringReader;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.inject.Inject;
import javax.json.Json;
import javax.json.JsonObject;
import javax.websocket.EncodeException;
import javax.websocket.OnClose;
import javax.websocket.OnError;
import javax.websocket.OnMessage;
import javax.websocket.OnOpen;
import javax.websocket.Session;
import javax.websocket.server.ServerEndpoint;

import org.springframework.stereotype.Component;

import kr.or.navi.chat.server.config.ServerAppConfig;
import kr.or.navi.chat.web.service.ChatService;
import kr.or.navi.mypage.service.MypageService;
import kr.or.navi.vo.ChatRoomVO;
import kr.or.navi.vo.EmpVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
// WebSocket 서버 엔드포인트를 정의하는 어노테이션입니다.
@Component
@ServerEndpoint(value = "/usersServerEndpoint", configurator = ServerAppConfig.class)
public class UsersServerEndPoint {
    @Inject
    private ChatService chatService; // 채팅 DAO 객체를 주입받습니다.
    
    @Inject
    private MypageService myService; // 사원 DAO 객체를 주입받습니다.

    @OnOpen
    public void onOpen(Session userSession) {
        // 클라이언트와의 WebSocket 연결이 열렸을 때 실행되는 로직
        log.info("WebSocket 연결이 열렸습니다. 세션 ID: {}", userSession.getId());
       
    }

    @OnClose
    public void onClose(Session userSession) {
        // 클라이언트와의 WebSocket 연결이 닫혔을 때 실행되는 로직
        log.info("WebSocket 연결이 닫혔습니다. 세션 ID: {}", userSession.getId());
    }

    @OnError
    public void onError(Session userSession, Throwable throwable) {
        // WebSocket 연결 중 오류가 발생했을 때 실행되는 로직
        log.error("WebSocket 오류 발생. 세션 ID: {}", userSession.getId(), throwable);
    }
    
    // 클라이언트로부터 메시지를 받는 메서드입니다.
    @OnMessage
    public void handleMessage(String message, Session userSession) throws IOException, EncodeException {
    	String username = (String) userSession.getUserProperties().get("Username");
        // JSON 형식의 메시지를 파싱합니다.
        JsonObject jsonObject = Json.createReader(new StringReader(message)).readObject();
        String connectionType = null;
        if (jsonObject.containsKey("connectionType")) {
            connectionType = jsonObject.getString("connectionType");
        } else {
            log.error("메시지에 연결 타입이 포함되어 있지 않습니다.");
            // 적절한 예외 처리 또는 오류 처리를 수행합니다.
        }
        // 만약 연결 타입이 채팅 연결이라면,
        if ("chatConnection".equals(connectionType)) {
            // 연결하는 사용자 이름을 가져옵니다.
            String connectingUser = jsonObject.getString("connectingUser");
            String userId = jsonObject.getString("userId");
        	 // 선택한 사용자의 정보를 가져옵니다.
            List<EmpVO> userList = chatService.chatEmpList(connectingUser);
            // 사용자 정보가 존재하는지 확인합니다.
            if (userList != null && !userList.isEmpty()) {
                // 해당 사용자가 존재하면 새로운 채팅방을 생성하고 사용자를 채팅방에 추가합니다.
	            // 해당 사용자의 채팅방 ID를 가져오거나 새로 생성합니다.
	            String roomId = getOrCreateChatRoom(connectingUser, userId);
	            // 클라이언트에게 채팅방 정보를 전송합니다.
	            sendRoomInfoToClient(roomId, userSession);
            } else {
                log.error("채팅을 시작할 수 없습니다. 사용자 정보를 찾을 수 없습니다.");
                // 클라이언트에게 채팅 시작 실패를 알릴 수 있는 메시지를 전송할 수도 있습니다.
            }
        }
    }

    // 사용자의 채팅방을 가져오거나 새로 생성하는 메서드입니다.
    private String getOrCreateChatRoom(String connectingUser, String userId) {
        // 이미 해당 사용자의 채팅방이 존재하는지 확인합니다.
        String roomId = chatService.checkRoom(connectingUser, userId);
        if (roomId != null) {
            // 채팅방이 이미 존재하면 해당 roomId를 반환합니다.
            return roomId;
        } else {
            // 해당 사용자의 정보를 데이터베이스에서 조회합니다.
            EmpVO empInfo = myService.selectOne(connectingUser);
            // 사용자 정보가 없는 경우 새로운 채팅방을 생성할 수 없습니다.
            if (empInfo == null) {
                log.error("사용자 정보를 찾을 수 없습니다아앙: {}", connectingUser);
                return null;
            }

            // 새로운 채팅방 VO 객체를 생성하고 이름을 설정합니다.
            ChatRoomVO roomVO = new ChatRoomVO();
            // 새로운 채팅방의 이름을 구성합니다.
            String roomName = empInfo.getEmpName() + empInfo.getPsName() + "(" + empInfo.getDeptName() + ")";
            roomVO.setRoomName(roomName);
            // 데이터베이스에 새로운 채팅방을 생성하고 ID를 받아옵니다.
            chatService.createPrivateRoom(roomVO);
            roomId = roomVO.getRoomId();
            
         // 채팅방이 성공적으로 생성되었는지 확인합니다.
            if (roomId != null) {
                // 채팅방에 사용자들을 추가합니다.
                chatService.addChatUser(roomId, connectingUser);
                chatService.addChatUser(roomId, userId);
            } else {
                log.error("채팅방을 생성할 수 없습니다.");
            }
            return roomId;
        }
    }

    // 클라이언트에게 채팅방 정보를 전송하는 메서드입니다.
    private void sendRoomInfoToClient(String roomId, Session userSession) throws IOException {
        // JSON 형식으로 채팅방 정보를 구성합니다.
        JsonObject roomInfo = Json.createObjectBuilder()
                .add("roomId", roomId)
                .build();
        // 클라이언트에게 채팅방 정보를 전송합니다.
        userSession.getBasicRemote().sendText(roomInfo.toString());
    }
}