<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core"  prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form"  prefix="form"%>
<%@ taglib uri="http://www.springframework.org/tags"  prefix="spring"%>
<link rel="stylesheet" href="${pageContext.request.contextPath }/resources/project/gant/dist/frappe-gantt.css" />
<script src="${pageContext.request.contextPath }/resources/project/gant/dist/frappe-gantt.js"></script>
<button type="button" class="btn btn-sm btn-light">Quarter Day</button>
<button type="button" class="btn btn-sm btn-light">Half Day</button>
<button type="button" class="btn btn-sm btn-light">Day</button>
<button type="button" class="btn btn-sm btn-light">Week</button>
<button type="button" class="btn btn-sm btn-light active">Month</button>
<div class="container">
		<h2 class="heading">Interactive Gantt Chart entirely made in SVG!</h2>
		<div class="gantt-target"></div>
	</div>
	<script>
	function getCsrfToken(){
	      return document.querySelector('meta[name="_csrf"]').getAttribute('content');
	   }
	   function getCsrfHeader(){
	      return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	   }
	   var tasks;
	fetch("${pageContext.request.contextPath }/project/gantt/${project.proId}",{
		method:"POST",
		headers:{
			"Accept":"application/json",
			[getCsrfHeader()]: getCsrfToken()
		}
	}).then(resp=>{
		if(resp.ok){
			return resp.json();
		}else{
			throw new Error(`상태코드 ${resp.status} 수신`,{cause:resp})
		}
	}).then(tasks=>{
		console.log(tasks)
		var gantt_chart = new Gantt(".gantt-target", tasks, {
			on_click: task => {
				console.log(task);
			},
			on_date_change: dateChange,
			on_progress_change: (task, progress) => {
				console.log(task, progress);
			},
			on_view_change: (mode) => {
				console.log(mode);
			},
			header_height: 50,
		    column_width: 30,
		    step: 24,
		    view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
		    bar_height: 20,
		    bar_corner_radius: 5,
		    arrow_curve: 1,
		    padding: 20,
		    view_mode: 'Month',
		    date_format: 'YYYY-MM-DD',
		    language: 'kr', // or 'es', 'it', 'ru', 'ptBr', 'fr', 'tr', 'zh', 'de', 'hu'
		    custom_popup_html: null
		});
		console.log(gantt_chart);
	}).catch(err=>{
		console.error(err);
	})
	function dateChange(task, start, end){
			console.log(task, start, end);
			console.log(start)
			let startDate = new Date(start);
			let endDate = new Date(end);
			
			let taskRegDt = startDate.toISOString(); // taskRegDt를 startDate로 설정
			let taskCompDt = endDate.toISOString(); // taskExCompDt를 endDate로 설정
			let data={
				taskId:task.id,
				taskRegDt:taskRegDt,
				taskCompDt:taskCompDt
			};
			let body=JSON.stringify(data);
			
			console.log("DATA",data)

			fetch("${pageContext.request.contextPath}/project/gantt/${project.proId}/date",{
				method:"POST",
				headers:{
					"Accept":"application/json",
					"Content-Type":"application/json",
					[getCsrfHeader()]: getCsrfToken()
				},body:body
			}).then(resp=>{
				if(resp.ok){
					return resp.text();
				}else{
					throw new Error(`상태코드 ${resp.status} 수신`,{cause:resp})
				}
			}).then(text=>{
				console.log(text)
			}).catch(err=>{
				console.error(err);
			})
	}
	</script>