<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.navi.chat.web.dao.ChatDAO">

	<!-- 사원목록 -->
	<select id="selectChatEmpList" resultType="EmpVO">
		SELECT E.EMP_IMG, E.EMP_ID, E.DEPT_ID, D.DEPT_NAME, E.PS_ID, P.PS_NAME, E.EMP_NAME, E.EMP_PASS
		FROM EMP E
		JOIN POSITION P ON (E.PS_ID = P.PS_ID)
		JOIN DEPT D ON (E.DEPT_ID = D.DEPT_ID)
		WHERE EMP_PASS IS NOT NULL AND NOT E.EMP_ID = #{empId}
		ORDER BY DEPT_NAME DESC, EMP_NAME DESC
	</select>
	
	<!-- 채팅방목록 -->
	<select id="selectChatList" resultType="ChatUserVO">
		SELECT
			CU.ROOM_ID
			, CR.ROOM_NAME
			, CR.ROOM_CREATE_DT
			, CU.EMP_ID
			, E.EMP_IMG
			, C.CHAT_CN AS LAST_CHAT
			, C.CHAT_SEND_DT AS LAST_CHAT_SEND_DT
		FROM CHAT_USER CU
		JOIN CHAT_ROOM CR ON (CU.ROOM_ID = CR.ROOM_ID)
		JOIN EMP E ON (CU.EMP_ID = E.EMP_ID)
		JOIN CHAT C ON (CU.ROOM_ID = C.ROOM_ID)
		WHERE CU.ROOM_ID IN (
		    SELECT ROOM_ID
		    FROM CHAT_USER
		    WHERE EMP_ID = #{empId}
		) AND CU.EMP_ID != #{empId}
		AND C.CHAT_SEND_DT = (
		    SELECT MAX(CHAT_SEND_DT)
		    FROM CHAT
		    WHERE ROOM_ID = CU.ROOM_ID
		)
	</select>
	
	
	<!-- 1:1채팅방이 이미 있는지 -->
	<select id="checkRoom">
		SELECT DISTINCT CR.ROOM_ID
		FROM CHAT_ROOM CR
		JOIN CHAT_USER CU ON CR.ROOM_ID = CU.ROOM_ID
		WHERE CR.ROOM_TYPE = 'P'
	    AND (CU.EMP_ID = ${empId} OR CU.EMP_ID =${empId})
	</select>
	
	<!-- 새로운 1:1채팅방 생성 -->
	<insert id="createPrivateRoom" parameterType="ChatRoomVO">
		<selectKey order="BEFORE" resultType="string" keyProperty="roomId">
			SELECT
				'R'||LPAD(NVL(TO_NUMBER(SUBSTR(MAX(ROOM_ID),5)),0)+1,5,'0')
			FROM CHAT_ROOM
		</selectKey>
		INSERT INTO CHAT_ROOM (
			ROOM_ID
			, ROOM_NAME
			, ROOM_TYPE
			, ROOM_DEL_YN
			, ROOM_CREATE_DT
		) VALUES (
			#{roomId}
			, #{roomName}
			, 'P'
			, NULL
			, SYSTIMESTAMP
		)
	</insert>
	
	<!-- 채팅방 생성 시 ChatUser에 insert -->
	<insert id="addChatUser" parameterType="ChatUserVO">
		INSERT INTO CHAT_USER (
			ROOM_ID
			, EMP_ID
		) VALUES (
			#{roomId}
			, #{empId}
		)
	</insert>
	
</mapper>